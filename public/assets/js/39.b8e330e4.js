(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{356:function(n,s,e){"use strict";e.r(s);var t=e(0),r=Object(t.a)({},(function(){var n=this,s=n.$createElement,e=n._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[e("h1",{attrs:{id:"kubernetes开发指南"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes开发指南"}},[n._v("#")]),n._v(" kubernetes开发指南")]),n._v(" "),e("h2",{attrs:{id:"官方例子"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#官方例子"}},[n._v("#")]),n._v(" 官方例子")]),n._v(" "),e("p",[n._v("大部分使用方式调用clientgo即可，我增加一些clientgo事例里没有的一些技巧")]),n._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/kubernetes/client-go/tree/master/examples",target:"_blank",rel:"noopener noreferrer"}},[n._v("clientgo 事例地址"),e("OutboundLink")],1)]),n._v(" "),e("h2",{attrs:{id:"初始化客户端"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#初始化客户端"}},[n._v("#")]),n._v(" 初始化客户端")]),n._v(" "),e("p",[n._v("这里给了两种初始化kubernetes客户端的方式，一种根据kubeconfig文件的路径，官方有，比较简单")]),n._v(" "),e("p",[n._v("另一种就是根据kubeconfig内容的字符串去初始化一个客户端，这种方式应用场景是比如我们把很多的kubeconfig文件存在了数据库中（多租户时）\n")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('package client\n\nimport (\n\t"fmt"\n\n\t"github.com/Sirupsen/logrus"\n\n\t"git.xfyun.cn/container/genesis/modules/authentication"\n\t"git.xfyun.cn/container/genesis/utils"\n\n\t"k8s.io/client-go/kubernetes"\n\t"k8s.io/client-go/tools/clientcmd"\n)\n\n//KubeClientFromKubeconfigPath is\nfunc KubeClientFromKubeconfigPath(path string) (clientSet *kubernetes.Clientset, err error) {\n\n\tcfg, err := clientcmd.BuildConfigFromFlags("", path)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf("new kube config error: %s", err)\n\t}\n\n\tif clientSet, err = kubernetes.NewForConfig(cfg); err != nil {\n\t\treturn nil, fmt.Errorf("new kube config error: %s", err)\n\t}\n\treturn clientSet, nil\n}\n\n//KubeClientFromKubeconfigStringBody is\nfunc KubeClientFromKubeconfigStringBody(body string) (*kubernetes.Clientset, error) {\n\tb, err := utils.Base64Decode(body)\n\tif err != nil {\n\t\treturn nil, err\n\t}\n\n\tlogrus.Debugf("Fetch kubeconfig string: %s", string(b))\n\tclientConfig, err := clientcmd.NewClientConfigFromBytes(b)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf("new client config from body error: %s", err)\n\t}\n\tcfg, err := clientConfig.ClientConfig()\n\tif err != nil {\n\t\treturn nil, fmt.Errorf("new kube config from body error: %s", err)\n\t}\n\n\tclientSet, err := kubernetes.NewForConfig(cfg)\n\tif err != nil {\n\t\treturn nil, fmt.Errorf("new kube config from body error: %s", err)\n\t}\n\treturn clientSet, nil\n}\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br"),e("span",{staticClass:"line-number"},[n._v("35")]),e("br"),e("span",{staticClass:"line-number"},[n._v("36")]),e("br"),e("span",{staticClass:"line-number"},[n._v("37")]),e("br"),e("span",{staticClass:"line-number"},[n._v("38")]),e("br"),e("span",{staticClass:"line-number"},[n._v("39")]),e("br"),e("span",{staticClass:"line-number"},[n._v("40")]),e("br"),e("span",{staticClass:"line-number"},[n._v("41")]),e("br"),e("span",{staticClass:"line-number"},[n._v("42")]),e("br"),e("span",{staticClass:"line-number"},[n._v("43")]),e("br"),e("span",{staticClass:"line-number"},[n._v("44")]),e("br"),e("span",{staticClass:"line-number"},[n._v("45")]),e("br"),e("span",{staticClass:"line-number"},[n._v("46")]),e("br"),e("span",{staticClass:"line-number"},[n._v("47")]),e("br"),e("span",{staticClass:"line-number"},[n._v("48")]),e("br"),e("span",{staticClass:"line-number"},[n._v("49")]),e("br"),e("span",{staticClass:"line-number"},[n._v("50")]),e("br"),e("span",{staticClass:"line-number"},[n._v("51")]),e("br")])]),e("h2",{attrs:{id:"yaml文件解析技巧"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#yaml文件解析技巧"}},[n._v("#")]),n._v(" yaml文件解析技巧")]),n._v(" "),e("p",[n._v("yaml文件中的---进行切分时很多一些yaml库没法解析，需要自己进行切分，当然k8s源码里已经有了对应实现，我们拿来用即可")]),n._v(" "),e("p",[n._v("编写一个回调函数进行处理，拿到的就是切分好的json了")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('package utils\n\nimport (\n\t"bytes"\n\t"fmt"\n\t"io"\n\n\t"k8s.io/apimachinery/pkg/runtime"\n\t"k8s.io/apimachinery/pkg/util/yaml"\n)\n\nvar bs = []byte(`\nkind: Namespace\nmetadata:\n   name: test\n---\n\nkind: bbb\nname: aaa`)\n\n/* Out put\n{"kind":"Namespace","metadata":{"name":"test"}}\n{"kind":"bbb","name":"aaa"}\n*/\nfunc example() {\n\treader := bytes.NewReader(bs)\n\text := runtime.RawExtension{}\n\td := yaml.NewYAMLOrJSONDecoder(reader, 4096)\n\tfor {\n\t\tif err := d.Decode(&ext); err != nil {\n\t\t\tif err == io.EOF {\n\t\t\t\treturn\n\t\t\t}\n\t\t\treturn\n\t\t}\n\t\tfmt.Println(string(ext.Raw))\n\t}\n}\n\n//YamlCallback is\ntype YamlCallback func([]byte) error\n\n//YamlHandler is\nfunc YamlHandler(rawBytes []byte, fn YamlCallback) (err error) {\n\treader := bytes.NewReader(rawBytes)\n\text := runtime.RawExtension{}\n\td := yaml.NewYAMLOrJSONDecoder(reader, 4096)\n\tfor {\n\t\tif err = d.Decode(&ext); err != nil {\n\t\t\tif err == io.EOF {\n\t\t\t\treturn nil\n\t\t\t}\n\t\t\treturn fmt.Errorf("decode yaml json failed: %v", err)\n\t\t}\n\t\t//Raw is already to json\n\t\tif err = fn(ext.Raw); err != nil {\n\t\t\treturn fmt.Errorf("handler yaml callback fn failed: %v", err)\n\t\t}\n\t}\n}\n\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br"),e("span",{staticClass:"line-number"},[n._v("23")]),e("br"),e("span",{staticClass:"line-number"},[n._v("24")]),e("br"),e("span",{staticClass:"line-number"},[n._v("25")]),e("br"),e("span",{staticClass:"line-number"},[n._v("26")]),e("br"),e("span",{staticClass:"line-number"},[n._v("27")]),e("br"),e("span",{staticClass:"line-number"},[n._v("28")]),e("br"),e("span",{staticClass:"line-number"},[n._v("29")]),e("br"),e("span",{staticClass:"line-number"},[n._v("30")]),e("br"),e("span",{staticClass:"line-number"},[n._v("31")]),e("br"),e("span",{staticClass:"line-number"},[n._v("32")]),e("br"),e("span",{staticClass:"line-number"},[n._v("33")]),e("br"),e("span",{staticClass:"line-number"},[n._v("34")]),e("br"),e("span",{staticClass:"line-number"},[n._v("35")]),e("br"),e("span",{staticClass:"line-number"},[n._v("36")]),e("br"),e("span",{staticClass:"line-number"},[n._v("37")]),e("br"),e("span",{staticClass:"line-number"},[n._v("38")]),e("br"),e("span",{staticClass:"line-number"},[n._v("39")]),e("br"),e("span",{staticClass:"line-number"},[n._v("40")]),e("br"),e("span",{staticClass:"line-number"},[n._v("41")]),e("br"),e("span",{staticClass:"line-number"},[n._v("42")]),e("br"),e("span",{staticClass:"line-number"},[n._v("43")]),e("br"),e("span",{staticClass:"line-number"},[n._v("44")]),e("br"),e("span",{staticClass:"line-number"},[n._v("45")]),e("br"),e("span",{staticClass:"line-number"},[n._v("46")]),e("br"),e("span",{staticClass:"line-number"},[n._v("47")]),e("br"),e("span",{staticClass:"line-number"},[n._v("48")]),e("br"),e("span",{staticClass:"line-number"},[n._v("49")]),e("br"),e("span",{staticClass:"line-number"},[n._v("50")]),e("br"),e("span",{staticClass:"line-number"},[n._v("51")]),e("br"),e("span",{staticClass:"line-number"},[n._v("52")]),e("br"),e("span",{staticClass:"line-number"},[n._v("53")]),e("br"),e("span",{staticClass:"line-number"},[n._v("54")]),e("br"),e("span",{staticClass:"line-number"},[n._v("55")]),e("br"),e("span",{staticClass:"line-number"},[n._v("56")]),e("br"),e("span",{staticClass:"line-number"},[n._v("57")]),e("br"),e("span",{staticClass:"line-number"},[n._v("58")]),e("br"),e("span",{staticClass:"line-number"},[n._v("59")]),e("br"),e("span",{staticClass:"line-number"},[n._v("60")]),e("br"),e("span",{staticClass:"line-number"},[n._v("61")]),e("br")])]),e("h2",{attrs:{id:"监听service事件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监听service事件"}},[n._v("#")]),n._v(" 监听service事件")]),n._v(" "),e("p",[n._v("出自kube-proxy源码")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('// informers "k8s.io/kubernetes/pkg/client/informers/informers_generated/internalversion"\n\n// 先根据client获取个informer工厂\ninformerFactory := informers.NewSharedInformerFactory(s.Client, s.ConfigSyncPeriod)\n\n// 生产个service的informer，同样可以监听别的对象\nserviceInformer=informerFactory.Core().InternalVersion().Services()\n\n/*\n\tAddFunc    func(obj interface{})\n\tUpdateFunc func(oldObj, newObj interface{})\n\tDeleteFunc func(obj interface{})\n*/\nserviceInformer.Informer().AddEventHandlerWithResyncPeriod(\n\tcache.ResourceEventHandlerFuncs{\n\t\tAddFunc:    result.handleAddService, // 你自己的回调函数\n\t\tUpdateFunc: result.handleUpdateService,\n\t\tDeleteFunc: result.handleDeleteService,\n\t},\n\tresyncPeriod,\n)\ninformerFactory.Start(wait.NeverStop) // 开始监听\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br"),e("span",{staticClass:"line-number"},[n._v("17")]),e("br"),e("span",{staticClass:"line-number"},[n._v("18")]),e("br"),e("span",{staticClass:"line-number"},[n._v("19")]),e("br"),e("span",{staticClass:"line-number"},[n._v("20")]),e("br"),e("span",{staticClass:"line-number"},[n._v("21")]),e("br"),e("span",{staticClass:"line-number"},[n._v("22")]),e("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);